import{j as G,k as i,r as H,o as I,n as Z,s as J,m as z,w as v,e as y,f as K,v as Q,d as r,c as g,x as R,F as B,a as A,b as c,h as x,t as _,y as W,z as ee,_ as oe}from"./index-B9shPAHu.js";import{L as N}from"./MapLayout.vue_vue_type_style_index_0_scoped_d1807789_lang-CFDAK7Ip.js";import{u as te,s as ne,i as ae,a as se,M as ie,L as le,B as re}from"./BusSidebar-fCooAQTl.js";import{t as ue}from"./tdxApi-B5FbKraf.js";import{f as ce}from"./bus-BvN3M9B5.js";const de=["onClick"],fe={class:"card-content__lable"},ve={class:"text-unit text-red"},me=G({__name:"BusＭapSearch",setup(he){const{routesCity:M}=ce(),L=te(),S=i(!1),w=i(null),d=i(null),m=i(null),b=i(null),P=i([]),u=H({});I(async()=>{await Z(),w.value?.getMap?(d.value=w.value.getMap(),console.log("Leaflet map ready",d.value)):console.warn("LeafletMap 尚未 ready"),j()});const k=i(!0),E=()=>{k.value=!k.value},F=(t,e,l,n)=>{console.log(n,"detail"),t?(S.value=!0,b.value=e,u.departureStopName=n.DepartureStopName.Zh_tw,u.destinationStopName=n.DestinationStopName.Zh_tw,u.startStop=n.StartStop.Zh_tw,u.endStop=n.EndStop.StopName.Zh_tw,u.ticketPriceDescription=n.TicketPriceDescription.Zh_tw,u.operatorName=n.Operators,Y(l)):b.value===e&&(b.value=null)},O=new N.Icon({iconUrl:se,iconRetinaUrl:ae,shadowUrl:ne,iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),V=t=>{console.log(t,"payload");let e=t;if((t&&t.BusPosition?t:null)&&(e=t.BusPosition),typeof e=="string")try{e=JSON.parse(e)}catch{}if(e&&!Array.isArray(e)&&typeof e=="object"&&(Array.isArray(e.Positions)?e=e.Positions:Array.isArray(e.Stops)?e=e.Stops:Array.isArray(e.Geo)?e=e.Geo:e.Position?e=e.Position:e.location&&Array.isArray(e.location)?e=e.location:e.Lat!==void 0&&e.Lon!==void 0?e=[[e.Lat,e.Lon]]:e.PositionLat!==void 0&&e.PositionLon!==void 0?e=[[e.PositionLat,e.PositionLon]]:e.PositionLon!==void 0&&e.PositionLat!==void 0?e=[[e.PositionLat,e.PositionLon]]:e.StopPositionLat!==void 0&&e.StopPositionLon!==void 0?e=[[e.StopPositionLat,e.StopPositionLon]]:e.Y!==void 0&&e.X!==void 0?e=[[e.Y,e.X]]:e.latitude!==void 0&&e.longitude!==void 0&&(e=[[e.latitude,e.longitude]])),!d.value)return;if(m.value?m.value.clearLayers():m.value=N.layerGroup().addTo(d.value),!e||e.length===0){console.warn("toggleShowLine: no positions found",{payload:t});return}const n=[],f=e[0];if(Array.isArray(f)&&f.length>=2){const o=Number(f[0]);!Number.isNaN(o)&&Math.abs(o)<=90?e.forEach(s=>n.push([Number(s[0]),Number(s[1])])):e.forEach(s=>n.push([Number(s[1]),Number(s[0])]))}else typeof f=="object"&&e.forEach(o=>{if(o.Lat!==void 0&&o.Lon!==void 0)n.push([Number(o.Lat),Number(o.Lon)]);else if(o.Latitude!==void 0&&o.Longitude!==void 0)n.push([Number(o.Latitude),Number(o.Longitude)]);else if(o.PositionLat!==void 0&&o.PositionLon!==void 0)n.push([Number(o.PositionLat),Number(o.PositionLon)]);else if(o.StopPositionLat!==void 0&&o.StopPositionLon!==void 0)n.push([Number(o.StopPositionLat),Number(o.StopPositionLon)]);else if(o.Y!==void 0&&o.X!==void 0)n.push([Number(o.Y),Number(o.X)]);else if(o.lat!==void 0&&o.lng!==void 0)n.push([Number(o.lat),Number(o.lng)]);else if(o.longitude!==void 0&&o.latitude!==void 0)n.push([Number(o.latitude),Number(o.longitude)]);else if(o[0]!==void 0&&o[1]!==void 0){const s=Number(o[0]),T=Number(o[1]);!Number.isNaN(s)&&Math.abs(s)<=90?n.push([s,T]):n.push([T,s])}});if(n.length===0){console.warn("toggleShowLine: parsed 0 latlngs",{positions:e,payload:t});return}const a=N.polyline(n,{color:"#1976d2",weight:4}).addTo(m.value);n.forEach(([o,s])=>{N.marker([o,s],{icon:O}).bindPopup(`${t.SubRouteName.Zh_tw}`).addTo(m.value)}),d.value.fitBounds(a.getBounds(),{padding:[20,20]});try{d.value.fitBounds(a.getBounds(),{padding:[20,20]})}catch(o){console.error(o)}},U=()=>{L.closeLoading()};async function j(){try{L.openLoading();const t=[q()],e=await Promise.allSettled(t),l=e[0],n=e[1];l?.status==="rejected"&&console.error("Route API Failed:",l.reason),n?.status}catch(t){console.error("Initialization error:",t)}finally{L.closeLoading()}}const C=i([]);function q(){C.value=M}const X=i(""),h=i(null),p=i(null),D=()=>{if(h.value||p.value){const t=h.value.getBoundingClientRect(),e=p.value.getBoundingClientRect(),l=t.height+e.height;X.value=`calc(95vh - ${l}px)`}};I(async()=>{await Z();const t=new ResizeObserver(()=>{D()});h.value&&t.observe(h.value),p.value&&t.observe(p.value),D(),J(()=>{t.disconnect()})});function Y(t){P.value=[],L.openLoading(),ue.get(`/Bus/RealTimeByFrequency/City/Tainan/${t}?%24top=30&%24format=JSON`).then(e=>{console.log(e),P.value=e.data.A1Datas}).catch(e=>{console.log(e)}).finally(()=>{})}function $(t){let e="";return t===0?e="正常營運":t===1?e="暫停營運":t===2&&(e="末班車已過"),e}return(t,e)=>{const l=A("el-check-tag"),n=A("el-button"),f=A("el-drawer");return c(),z(ie,null,{sidebar:v(()=>[y(re,null,{top:v(()=>[r("div",{ref_key:"controlRef",ref:h,class:"control-container"},[e[2]||(e[2]=r("div",{class:"control-text"},"以「選單方式」查詢預估資訊",-1)),r("div",{class:"control-icon",onClick:E},[...e[1]||(e[1]=[r("span",{class:"material-symbols-outlined"}," tune ",-1)])])],512)]),default:v(()=>[K(r("div",{ref_key:"controlStatusRef",ref:p,class:"controlStatus-container"},[(c(!0),g(B,null,R(C.value?.Routes,(a,o)=>(c(),z(l,{key:a.RouteID,checked:b.value===o,onChange:s=>F(s,o,a.RouteName.Zh_tw,a)},{default:v(()=>[x(_(a.RouteName.Zh_tw),1)]),_:2},1032,["checked","onChange"]))),128))],512),[[Q,k.value]])]),_:1}),y(f,{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=a=>S.value=a),direction:"btt",size:"100%",resizable:"",onClose:U},{default:v(()=>[r("div",null,[(c(!0),g(B,null,R(u?.operatorName,a=>(c(),g("span",{key:a.OperatorID,style:{display:"flex","align-items":"center"}},[e[3]||(e[3]=r("span",{style:{"font-size":"18px"},class:"material-symbols-outlined"},"directions_subway",-1)),x(" "+_(a.OperatorName.Zh_tw),1)]))),128)),(c(!0),g(B,null,R(P.value,(a,o)=>(c(),g("div",{class:"card-content__item",key:a.SubRouteID,onClick:s=>V(a)},[r("h1",fe,[x(_(a.SubRouteName.Zh_tw)+" ",1),y(n,{icon:W(ee),circle:"",size:"small",color:"#6A994E",plain:""},null,8,["icon"])]),r("span",ve,_($(a.DutyStatus)),1)],8,de))),128))])]),_:1},8,["modelValue"])]),map:v(()=>[y(le,{ref_key:"mapRef",ref:w},null,512)]),_:1})}}}),_e=oe(me,[["__scopeId","data-v-aaff08b8"]]);export{_e as default};
