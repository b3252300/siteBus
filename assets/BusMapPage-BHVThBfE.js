import{_ as De,k as l,o as ae,n as Me,s as Te,m as D,w as c,e as p,f as L,A as He,y as U,a as m,B as Le,d as r,g as ne,c as w,x as P,F as $,C as oe,h as le,t as y,b as u,v as Ue}from"./index-DcN3C2cl.js";import{L as z}from"./MapLayout.vue_vue_type_style_index_0_scoped_3b769f6d_lang-BhciEHik.js";import{u as Ee,s as ie,L as be,B as Ve,M as Ie,i as xe,a as Ne}from"./BusSidebar-D4AV_DRg.js";import{t as E}from"./tdxApi-B5FbKraf.js";import{u as Re}from"./date-TIK336lM.js";const Ze="data:image/svg+xml,%3csvg%20width='22'%20height='14'%20viewBox='0%200%2022%2014'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M16%200H2C0.9%200%200%200.89%200%202V11H2C2%2012.65%203.34%2014%205%2014C6.66%2014%208%2012.65%208%2011H13.5C13.5%2012.65%2014.84%2014%2016.5%2014C18.16%2014%2019.5%2012.65%2019.5%2011H22V6L16%200ZM2%206V2H6V6H2ZM5%2012.5C4.17%2012.5%203.5%2011.83%203.5%2011C3.5%2010.17%204.17%209.5%205%209.5C5.83%209.5%206.5%2010.17%206.5%2011C6.5%2011.83%205.83%2012.5%205%2012.5ZM12%206H8V2H12V6ZM16.5%2012.5C15.67%2012.5%2015%2011.83%2015%2011C15%2010.17%2015.67%209.5%2016.5%209.5C17.33%209.5%2018%2010.17%2018%2011C18%2011.83%2017.33%2012.5%2016.5%2012.5ZM14%206V2H15L19%206H14Z'%20fill='%23606266'/%3e%3c/svg%3e",Be="data:image/svg+xml,%3csvg%20width='100'%20height='64'%20viewBox='0%200%20100%2064'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3ccircle%20cx='24'%20cy='50'%20r='10'%20fill='white'/%3e%3ccircle%20cx='76'%20cy='50'%20r='10'%20fill='white'/%3e%3cpath%20d='M68%201H7V37H93L68%201Z'%20fill='white'/%3e%3cpath%20d='M72.7273%200H9.09091C4.09091%200%200%204.06857%200%209.14286V50.2857H9.09091C9.09091%2057.8286%2015.1818%2064%2022.7273%2064C30.2727%2064%2036.3636%2057.8286%2036.3636%2050.2857H61.3636C61.3636%2057.8286%2067.4545%2064%2075%2064C82.5455%2064%2088.6364%2057.8286%2088.6364%2050.2857H100V27.4286L72.7273%200ZM9.09091%2027.4286V9.14286H27.2727V27.4286H9.09091ZM22.7273%2057.1429C18.9545%2057.1429%2015.9091%2054.08%2015.9091%2050.2857C15.9091%2046.4914%2018.9545%2043.4286%2022.7273%2043.4286C26.5%2043.4286%2029.5455%2046.4914%2029.5455%2050.2857C29.5455%2054.08%2026.5%2057.1429%2022.7273%2057.1429ZM54.5455%2027.4286H36.3636V9.14286H54.5455V27.4286ZM75%2057.1429C71.2273%2057.1429%2068.1818%2054.08%2068.1818%2050.2857C68.1818%2046.4914%2071.2273%2043.4286%2075%2043.4286C78.7727%2043.4286%2081.8182%2046.4914%2081.8182%2050.2857C81.8182%2054.08%2078.7727%2057.1429%2075%2057.1429ZM63.6364%2027.4286V9.14286H68.1818L86.3636%2027.4286H63.6364Z'%20fill='url(%23paint0_linear_35_13)'/%3e%3cdefs%3e%3clinearGradient%20id='paint0_linear_35_13'%20x1='50'%20y1='0'%20x2='50'%20y2='64'%20gradientUnits='userSpaceOnUse'%3e%3cstop%20offset='0.491279'%20stop-color='%23CB4539'/%3e%3cstop%20offset='1'%20stop-color='%2365221C'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",Ae={class:"title-container__label"},Oe={class:"title-container__sublabel"},Pe={class:"searchDate-container"},$e={class:"list-container"},ze=["onClick"],qe=["innerHTML"],Fe={class:"text-unit"},Je={class:"stop__line"},Ye=["onClick"],Ge=["innerHTML"],Ke={__name:"BusMapPage",setup(je){const{GetDateTimeYYYYMMDDHHmm:se}=Re(),M=Ee(),h=l(null),b=l(!1),T=l(null),q=l(null),g=l(null),re=l(!0),F=l(null),k=l([]),_=l([]),S=l([]),V=l("go"),J=l(null),v=new Map,I=l(""),x=l(""),ce=z.icon({iconUrl:Be,shadowUrl:ie,iconSize:[36,46],iconAnchor:[18,46],popupAnchor:[0,-40]});let N=new Date;ae(async()=>{g.value=q.value.getMap(),await R(),setInterval(()=>{R(),console.log("公車資料已更新於："+N.toLocaleTimeString())},18e4)});async function R(){try{M.openLoading(),await Promise.all([fe(),de()]),Z()}catch{}finally{M.closeLoading(),N=new Date}}const ue=()=>{R()};function fe(){return E.get("/Bus/Network/City/Tainan?%24format=JSON").then(e=>{F.value=e.data})}function Y(e){return b.value=!0,E.get("/Bus/EstimatedTimeOfArrival/City/Tainan?%24format=JSON").then(t=>{console.log(t.data,"estimatedTimeOfArrival");const{N1Datas:a}=t.data;let o=!1;a.forEach(n=>{n.StopUID===e&&(o=!0,h.value=A(n.EstimateTime),T.value=ee(n.EstimateTime),console.log(n,"item"),B(e,n.EstimateTime))}),o||B(e,null)}).catch(()=>{h.value="請求過快，請稍後",T.value=null}).finally(()=>{b.value=!1})}function de(){return E.get("/Bus/StopOfRoute/City/Tainan?%24format=JSON").then(e=>{k.value=e.data.StopOfRoutes||[],k.value.forEach(t=>{t.Stops=[...t.Stops].sort((a,o)=>a.StopSequence-o.StopSequence)})})}function pe(){W(),Z()}function Z(){_.value=V.value==="go"?k.value.filter(e=>e.Direction===1):k.value.filter(e=>e.Direction===0),S.value=_.value.map(()=>!1)}async function me(e){S.value[e]=!S.value[e];const t=_.value[e];S.value[e]?await ve(t):ge(t)}async function ve(e){if(g.value){e.Stops.forEach(t=>{const a=t.StopPosition?.PositionLat,o=t.StopPosition?.PositionLon;if(!a||!o||v.has(t.StopUID))return;const n=z.icon({iconUrl:Ne,iconRetinaUrl:xe,iconSize:[28,36],iconAnchor:[14,36],popupAnchor:[0,-36],shadowUrl:ie}),i=z.marker([a,o],{icon:n}).addTo(g.value);i._originalIcon=n,i._stopUID=t.StopUID,i._estimateSeconds=null,i.bindTooltip(t.StopName.Zh_tw,{direction:"top",offset:[0,-10]}),i.on("click",()=>{X(t);const d=i._estimateSeconds;d!=null?(h.value=A(d),T.value=ee(d)):Y(t.StopUID)}),v.set(t.StopUID,i)});try{const t=await E.get("/Bus/EstimatedTimeOfArrival/City/Tainan?%24format=JSON"),{N1Datas:a=[]}=t.data||{},o=new Map;a.forEach(n=>{n.StopUID&&n.EstimateTime!==void 0&&o.set(n.StopUID,n.EstimateTime)}),e.Stops.forEach(n=>{const i=o.has(n.StopUID)?o.get(n.StopUID):null;B(n.StopUID,i);const d=v.get(n.StopUID);d&&(d._estimateSeconds=i)})}catch(t){console.warn("fetch estimates failed",t)}}}function B(e,t){const a=v.get(e);if(!a)return;if(a._estimateSeconds=t===void 0?null:t,(t==null?null:A(t))==="即將到站"){a.setIcon(ce);const n=a.getElement();n&&n.classList.add("marker-soon")}else{a._originalIcon&&a.setIcon(a._originalIcon);const n=a.getElement();n&&n.classList.remove("marker-soon")}}const G=l("80vh"),H=l(null),f=l(null),K=()=>{const e=H.value,t=e?e.getBoundingClientRect().height:0;let a=0;Array.isArray(f.value)&&f.value.length>0?f.value.forEach(n=>{a+=n.getBoundingClientRect()?.height}):f.value;const o=t+a;G.value=`calc(95vh - ${o}px)`};ae(async()=>{await Me();const e=new ResizeObserver(()=>{K()});H.value&&e.observe(H.value),Array.isArray(f.value)?f.value.forEach(t=>e.observe(t)):f.value&&e.observe(f.value),K(),Te(()=>{e.disconnect()})});const _e=()=>{const e=I.value.trim().toLowerCase();if(x.value=e,!e){Z();return}_.value=k.value.filter(t=>t.SubRouteName.Zh_tw.toLowerCase().includes(e)||t.Stops.some(a=>a.StopName.Zh_tw.toLowerCase().includes(e))),S.value=_.value.map(()=>!1),W()};function j(e=""){return String(e).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[t])}function he(e=""){return String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Q(e,t){if(!t)return j(e);const a=he(t),o=new RegExp(a,"ig");return j(e).replace(o,n=>`<mark class="search-mark">${n}</mark>`)}function ge(e){e.Stops.forEach(t=>{const a=v.get(t.StopUID);a&&(g.value.removeLayer(a),v.delete(t.StopUID))})}function W(){v.forEach(e=>g.value.removeLayer(e)),v.clear()}function X(e){const t=e.StopPosition?.PositionLat,a=e.StopPosition?.PositionLon;!t||!a||(J.value=e.StopUID,g.value.setView([t,a],16),Y(e.StopUID))}function Se(e){return e===1?"去程":"回程"}const A=e=>{if(e==null||e<0)return"未發車";const t=Math.floor(e/60);return t<1?"進站中":t<2?"即將到站":`剩 ${t} 分鐘到站`},ee=e=>e<60?"danger":e<120?"warning":"success";return(e,t)=>{const a=m("el-radio-button"),o=m("el-radio-group"),n=m("el-text"),i=m("search"),d=m("el-icon"),Ce=m("el-input"),we=m("el-empty"),ye=m("el-card"),ke=m("el-scrollbar"),O=He("loading");return u(),D(Ie,null,{sidebar:c(()=>[p(Ve,null,{top:c(()=>[(u(!0),w($,null,P(F.value?.Networks,s=>(u(),w("div",{ref_for:!0,ref_key:"titleRef",ref:f,key:s.SubRouteUID,class:"title-container"},[r("h2",Ae,y(s.NetworkName.Zh_tw),1),r("div",Oe,y(s.NetworkName.En),1)]))),128)),r("div",{ref_key:"controlRef",ref:H,class:"control-container"},[p(o,{modelValue:V.value,"onUpdate:modelValue":t[0]||(t[0]=s=>V.value=s),size:"small",onChange:pe},{default:c(()=>[p(a,{label:"去程",value:"go",type:"success"}),p(a,{label:"往返",value:"back",type:"success"})]),_:1},8,["modelValue"]),h.value?L((u(),D(n,{key:h.value,class:oe(["text-estimatedTime",T.value])},{default:c(()=>[t[2]||(t[2]=r("img",{src:Ze},null,-1)),le(y(h.value),1)]),_:1},8,["class"])),[[O,b.value]]):ne("",!0)],512),r("div",Pe,[p(Ce,{modelValue:I.value,"onUpdate:modelValue":t[1]||(t[1]=s=>I.value=s),class:"responsive-input",placeholder:"請搜尋",onChange:_e},{suffix:c(()=>[p(d,{class:"el-input__icon"},{default:c(()=>[p(i)]),_:1})]),_:1},8,["modelValue"]),L((u(),w("div",{class:"updateTime",onClick:ue},[p(n,null,{default:c(()=>[le("更新時間 "+y(U(se)(U(N))),1)]),_:1})])),[[O,U(M).loading]])])]),default:c(()=>[L((u(),D(ke,{style:Le({height:G.value})},{default:c(()=>[r("div",$e,[!re.value&&_.value.length===0?(u(),D(we,{key:0,description:"附近無資料"})):ne("",!0),(u(!0),w($,null,P(_.value,(s,te)=>(u(),D(ye,{key:s.SubRouteUID},{default:c(()=>[r("h3",{class:"label_style",onClick:C=>me(te)},[r("span",{innerHTML:Q(s.SubRouteName.Zh_tw,x.value)},null,8,qe),r("span",Fe,y(Se(s.Direction)),1)],8,ze),L(r("div",Je,[(u(!0),w($,null,P(s.Stops,(C,Qe)=>(u(),w("div",{key:C.StopUID,class:oe(["location-top",{active:J.value===C.StopUID}]),onClick:We=>X(C)},[r("strong",null,y(C.StopSequence),1),r("span",{class:"stop-name",innerHTML:Q(C.StopName.Zh_tw,x.value)},null,8,Ge)],10,Ye))),128))],512),[[Ue,S.value[te]]])]),_:2},1024))),128))])]),_:1},8,["style"])),[[O,U(M).loading]])]),_:1})]),map:c(()=>[p(be,{ref_key:"mapRef",ref:q},null,512)]),_:1})}}},ot=De(Ke,[["__scopeId","data-v-54f3283c"]]);export{ot as default};
