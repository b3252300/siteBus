import{_ as X,k as a,o as A,n as Y,s as ee,m as b,w as u,e as m,f as I,A as te,y as oe,a as S,B as ae,d as s,g as ne,c as g,x as D,F as L,b as i,h as le,t as d,C as se,v as ie}from"./index-yuJo9kJe.js";import{L as T}from"./MapLayout.vue_vue_type_style_index_0_scoped_d1807789_lang-BgKthFHO.js";import{u as re,L as ce,B as ue,M as ve,s as fe,i as pe,a as de}from"./BusSidebar-DNObRifG.js";import{t as V}from"./tdxApi-B5FbKraf.js";const _e={class:"title-container__label"},he={class:"title-container__sublabel"},me={class:"list-container"},Se=["onClick"],ge={class:"text-unit"},ye={class:"stop__line"},ke=["onClick"],be={class:"stop-name"},we={__name:"BusMapPage",setup(Ce){const w=re(),R=a(null),v=a(null),O=a(!0),N=a(null),y=a([]),_=a([]),h=a([]),C=a("go"),U=a(null),f=new Map;A(async()=>{v.value=R.value.getMap(),await z()});async function z(){try{w.openLoading(),await Promise.all([q(),H()]),B()}catch{}finally{w.closeLoading()}}function q(){return V.get("/Bus/Network/City/Tainan?%24format=JSON").then(e=>{N.value=e.data})}function H(){return V.get("/Bus/StopOfRoute/City/Tainan?%24format=JSON").then(e=>{y.value=e.data.StopOfRoutes||[],y.value.forEach(t=>{t.Stops=[...t.Stops].sort((o,r)=>o.StopSequence-r.StopSequence)})})}function Z(){j(),B()}function B(){_.value=C.value==="go"?y.value.filter(e=>e.Direction===1):y.value.filter(e=>e.Direction===0),h.value=_.value.map(()=>!1)}function F(e){h.value[e]=!h.value[e];const t=_.value[e];h.value[e]?$(t):J(t)}function $(e){v.value&&e.Stops.forEach(t=>{const o=t.StopPosition?.PositionLat,r=t.StopPosition?.PositionLon;if(!o||!r||f.has(t.StopUID))return;const c=T.marker([o,r],{icon:T.icon({iconUrl:de,iconRetinaUrl:pe,iconSize:[28,36],iconAnchor:[14,36],popupAnchor:[0,-36],shadowUrl:fe})}).addTo(v.value);c.bindTooltip(t.StopName.Zh_tw,{direction:"top",offset:[0,-10]}),c.on("click",()=>{E(t)}),f.set(t.StopUID,c)})}const M=a("80vh"),k=a(null),l=a(null),P=()=>{const e=k.value,t=e?e.getBoundingClientRect().height:0;let o=0;Array.isArray(l.value)&&l.value.length>0?l.value.forEach(c=>{o+=c.getBoundingClientRect()?.height}):l.value;const r=t+o;M.value=`calc(95vh - ${r}px)`};A(async()=>{await Y();const e=new ResizeObserver(()=>{P()});k.value&&e.observe(k.value),Array.isArray(l.value)?l.value.forEach(t=>e.observe(t)):l.value&&e.observe(l.value),P(),ee(()=>{e.disconnect()})});function J(e){e.Stops.forEach(t=>{const o=f.get(t.StopUID);o&&(v.value.removeLayer(o),f.delete(t.StopUID))})}function j(){f.forEach(e=>v.value.removeLayer(e)),f.clear()}function E(e){const t=e.StopPosition?.PositionLat,o=e.StopPosition?.PositionLon;!t||!o||(U.value=e.StopUID,v.value.setView([t,o],16))}function G(e){return e===1?"去程":"回程"}return(e,t)=>{const o=S("el-radio-button"),r=S("el-radio-group"),c=S("el-empty"),K=S("el-card"),Q=S("el-scrollbar"),W=te("loading");return i(),b(ve,null,{sidebar:u(()=>[m(ue,null,{top:u(()=>[(i(!0),g(L,null,D(N.value?.Networks,n=>(i(),g("div",{ref_for:!0,ref_key:"titleRef",ref:l,key:n.SubRouteUID,class:"title-container"},[s("h2",_e,d(n.NetworkName.Zh_tw),1),s("div",he,d(n.NetworkName.En),1)]))),128)),s("div",{ref_key:"controlRef",ref:k,class:"control-container"},[m(r,{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=n=>C.value=n),size:"small",onChange:Z},{default:u(()=>[m(o,{label:"去程",value:"go",type:"success"}),m(o,{label:"往返",value:"back",type:"success"})]),_:1},8,["modelValue"])],512)]),default:u(()=>[I((i(),b(Q,{style:ae({height:M.value})},{default:u(()=>[s("div",me,[!O.value&&_.value.length===0?(i(),b(c,{key:0,description:"附近無資料"})):ne("",!0),(i(!0),g(L,null,D(_.value,(n,x)=>(i(),b(K,{key:n.SubRouteUID},{default:u(()=>[s("h3",{class:"label_style",onClick:p=>F(x)},[le(d(n.SubRouteName.Zh_tw)+" ",1),s("span",ge,d(G(n.Direction)),1)],8,Se),I(s("div",ye,[(i(!0),g(L,null,D(n.Stops,(p,De)=>(i(),g("div",{key:p.StopUID,class:se(["location-top",{active:U.value===p.StopUID}]),onClick:Le=>E(p)},[s("strong",null,d(p.StopSequence),1),s("span",be,d(p.StopName.Zh_tw),1)],10,ke))),128))],512),[[ie,h.value[x]]])]),_:2},1024))),128))])]),_:1},8,["style"])),[[W,oe(w).loading]])]),_:1})]),map:u(()=>[m(ce,{ref_key:"mapRef",ref:R},null,512)]),_:1})}}},Me=X(we,[["__scopeId","data-v-7d6ef77d"]]);export{Me as default};
